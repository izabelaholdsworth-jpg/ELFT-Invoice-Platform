{% extends 'base.html' %}

{% block content %}
<div class="max-w-4xl mx-auto h-[calc(100vh-12rem)] flex flex-col">
    <div class="bg-white rounded-t-lg shadow-sm border-b p-4 flex justify-between items-center">
        <div>
            <h2 class="text-xl font-bold text-gray-800"><i class="fas fa-robot text-nhs-blue mr-2"></i>Finance AI
                Assistant</h2>
            <p class="text-sm text-gray-500">Ask questions about spend, contracts, and suppliers.</p>
        </div>
        <div class="text-xs bg-blue-50 text-blue-800 px-3 py-1 rounded-full border border-blue-100">
            Powered by Claude 3.5 Sonnet
        </div>
    </div>

    <!-- Chat Messages Area -->
    <div id="chat-messages" class="flex-grow overflow-y-auto bg-gray-50 p-4 space-y-4">
        <!-- Welcome Message -->
        <div class="flex items-start">
            <div
                class="flex-shrink-0 bg-nhs-blue rounded-full p-2 w-8 h-8 flex items-center justify-center text-white mr-3">
                <i class="fas fa-robot text-xs"></i>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-sm max-w-2xl border border-gray-100">
                <p class="text-gray-800">Hello! I'm your ELFT Finance Assistant. I can help you analyze the trust's
                    spending data and contract register.</p>
                <p class="mt-2 text-sm text-gray-600 font-medium">Try asking:</p>
                <ul class="mt-1 text-sm text-nhs-blue space-y-1 list-disc list-inside">
                    <li class="cursor-pointer hover:underline" onclick="askQuestion(this.innerText)">Show me the top 5
                        suppliers by spend</li>
                    <li class="cursor-pointer hover:underline" onclick="askQuestion(this.innerText)">How much did we
                        spend on Agency Staff last month?</li>
                    <li class="cursor-pointer hover:underline" onclick="askQuestion(this.innerText)">List contracts
                        expiring in the next 90 days</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Input Area -->
    <div class="bg-white p-4 border-t rounded-b-lg shadow-lg">
        <form id="chat-form" class="flex gap-4">
            <input type="text" id="user-input"
                class="flex-grow border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-nhs-blue focus:border-nhs-blue"
                placeholder="Ask a question about the data..." autocomplete="off">
            <button type="submit"
                class="bg-nhs-blue text-white px-6 py-3 rounded-lg hover:bg-nhs-dark font-medium transition-colors shadow-sm flex items-center">
                <span>Send</span>
                <i class="fas fa-paper-plane ml-2"></i>
            </button>
        </form>
    </div>
</div>

<!-- SQL Preview Modal (Hidden by default) -->
<div id="sql-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 shadow-xl">
        <h3 class="text-lg font-bold mb-2">Executed SQL</h3>
        <pre class="bg-gray-800 text-green-400 p-4 rounded overflow-x-auto text-sm" id="sql-content"></pre>
        <button onclick="document.getElementById('sql-modal').classList.add('hidden')"
            class="mt-4 bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded">Close</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    const chatForm = document.getElementById('chat-form');
    const userInput = document.getElementById('user-input');
    const messagesDiv = document.getElementById('chat-messages');

    // Configure marked for better formatting
    marked.setOptions({
        breaks: true,
        gfm: true
    });

    chatForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const question = userInput.value.trim();
        if (!question) return;

        // Add User Message
        addMessage(question, 'user');
        userInput.value = '';

        // Show Typing Indicator
        const typingId = showTyping();
        scrollToBottom();

        try {
            const response = await fetch('/api/ai/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ question: question })
            });
            const data = await response.json();

            removeMessage(typingId);

            if (data.success) {
                let content = data.response;

                // If SQL was executed, add a button to view it
                if (data.sql) {
                    content += `\n\n---\n<div class="mt-3 pt-3 border-t border-gray-100">
                        <button onclick="showSql('${encodeURIComponent(data.sql)}')" class="text-xs text-gray-500 hover:text-nhs-blue flex items-center">
                            <i class="fas fa-database mr-1"></i> View Executed SQL Query
                        </button>
                    </div>`;
                }

                addMessage(content, 'ai');
            } else {
                addMessage(`Error: ${data.error}`, 'ai', true);
            }
        } catch (error) {
            removeMessage(typingId);
            addMessage('Sorry, something went wrong. Please check the implementation.', 'ai', true);
        }

        scrollToBottom();
    });

    function addMessage(text, sender, isError = false) {
        const div = document.createElement('div');
        div.className = 'flex items-start ' + (sender === 'user' ? 'justify-end' : '');

        const avatar = sender === 'ai'
            ? `<div class="flex-shrink-0 bg-nhs-blue rounded-full p-2 w-8 h-8 flex items-center justify-center text-white mr-3"><i class="fas fa-robot text-xs"></i></div>`
            : '';

        const userAvatar = sender === 'user'
            ? `<div class="flex-shrink-0 bg-gray-200 rounded-full p-2 w-8 h-8 flex items-center justify-center text-gray-600 ml-3"><i class="fas fa-user text-xs"></i></div>`
            : '';

        const bubbleColor = sender === 'user' ? 'bg-nhs-blue text-white' : (isError ? 'bg-red-50 text-red-800 border border-red-200' : 'bg-white text-gray-800 border border-gray-100 shadow-sm');

        // Convert markdown to HTML for AI messages
        const formattedText = sender === 'ai' && !isError ? marked.parse(text) : text;

        div.innerHTML = `
            ${avatar}
            <div class="${bubbleColor} p-4 rounded-lg max-w-2xl break-words prose prose-sm max-w-none">
                ${formattedText}
            </div>
            ${userAvatar}
        `;

        messagesDiv.appendChild(div);
    }

    function showTyping() {
        const id = 'typing-' + Date.now();
        const div = document.createElement('div');
        div.id = id;
        div.className = 'flex items-start';
        div.innerHTML = `
            <div class="flex-shrink-0 bg-nhs-blue rounded-full p-2 w-8 h-8 flex items-center justify-center text-white mr-3"><i class="fas fa-robot text-xs"></i></div>
            <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100">
                <div class="flex space-x-1">
                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                </div>
            </div>
        `;
        messagesDiv.appendChild(div);
        return id;
    }

    function removeMessage(id) {
        const el = document.getElementById(id);
        if (el) el.remove();
    }

    function askQuestion(text) {
        userInput.value = text;
        chatForm.dispatchEvent(new Event('submit'));
    }

    function scrollToBottom() {
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    window.showSql = function (encodedSql) {
        document.getElementById('sql-content').textContent = decodeURIComponent(encodedSql);
        document.getElementById('sql-modal').classList.remove('hidden');
    }
</script>
{% endblock %}